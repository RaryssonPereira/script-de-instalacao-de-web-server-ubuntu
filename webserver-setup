#!/bin/bash

# -------------------------------
# Script de InstalaÃ§Ã£o Base para Servidores Linux
# Criado por: Rarysson ğŸ’»
# Finalidade: Automatizar a configuraÃ§Ã£o inicial de servidores web
# -------------------------------

# === VARIÃVEIS GLOBAIS ===
LOG_EXEC="/etc/log_instalacao_base"
IP_SERVIDOR=$(curl -s https://api.ipify.org)
REVERSO=$(host "$IP_SERVIDOR" | awk '/pointer/ {print $5}' | sed 's/\.$//')
PADRAO_HOSTNAME=""
[ -n "$REVERSO" ] && PADRAO_HOSTNAME=$(echo "$REVERSO" | cut -d'.' -f1)

# === FUNÃ‡Ã•ES UTILITÃRIAS ===

verifica_execucao_anterior() {
    if [ -f "$LOG_EXEC" ]; then
        echo "âš ï¸ Este script jÃ¡ foi executado em: $(cat $LOG_EXEC)"
        echo "Abortando para evitar duplicaÃ§Ã£o."
        exit 1
    fi
}

obter_hostname() {
    echo ""
    echo "ğŸ–¥ï¸  CONFIGURAÃ‡ÃƒO DO HOSTNAME"
    echo "IP pÃºblico detectado: $IP_SERVIDOR"
    echo "Reverso PTR detectado: $REVERSO"

    if [ -n "$PADRAO_HOSTNAME" ]; then
        echo "SugestÃ£o de hostname baseado no reverso: $PADRAO_HOSTNAME"
        read -p "Digite o novo hostname ou pressione ENTER para usar '$PADRAO_HOSTNAME': " newhostname
        newhostname=${newhostname:-$PADRAO_HOSTNAME}
    else
        read -p "Nenhum padrÃ£o detectado. Digite o hostname desejado (ex: srv001): " newhostname
        while [ -z "$newhostname" ]; do
            echo "âš ï¸  Por favor, digite um hostname vÃ¡lido."
            read newhostname
        done
    fi

    echo "ğŸ”§ Aplicando hostname: $newhostname"
    hostnamectl set-hostname "$newhostname"
    echo "$newhostname" > /etc/hostname
}

pergunta_sim_nao() {
    local pergunta="$1"
    local resposta=""
    while [[ "$resposta" != "S" && "$resposta" != "N" ]]; do
        read -p "$pergunta (S/N): " resposta
        resposta=$(echo "$resposta" | tr 'a-z' 'A-Z')
    done
    echo "$resposta"
}

instalar_nginx() {
    echo ""
    echo "ğŸŒ INSTALAÃ‡ÃƒO DO NGINX"
    local resposta=$(pergunta_sim_nao "Deseja instalar o NGINX?")
    if [ "$resposta" == "S" ]; then
        apt update && apt install -y nginx
        echo "âœ… NGINX instalado com sucesso."
        configurar_projeto_web
    else
        echo "â­ï¸  Pulando a instalaÃ§Ã£o do NGINX."
    fi
}

configurar_projeto_web() {
    echo ""
    read -p "Deseja configurar um projeto web? (Digite o nome ou N para pular): " projectname

    if [[ "$projectname" != "N" && "$projectname" != "n" && -n "$projectname" ]]; then
        read -p "Digite o domÃ­nio principal do projeto (ex: exemplo.com): " domainname
        while [ -z "$domainname" ]; do
            echo "âš ï¸  DomÃ­nio nÃ£o pode ser vazio."
            read domainname
        done
        echo "ğŸ”§ Projeto '$projectname' com domÃ­nio '$domainname' serÃ¡ configurado posteriormente..."
        # Aqui podemos incluir a lÃ³gica de criaÃ§Ã£o do bloco de host NGINX, certificados SSL, etc.
    else
        echo "â­ï¸  Nenhum projeto configurado nesta etapa."
    fi
}

registrar_execucao() {
    echo "ğŸ“ Registrando execuÃ§Ã£o do script..."
    date "+%Y-%m-%d %H:%M:%S" > "$LOG_EXEC"
    echo "âœ”ï¸  Registro salvo em $LOG_EXEC"
}

# === FLUXO PRINCIPAL ===

clear
echo "==============================="
echo "ğŸ’¡ Script de InstalaÃ§Ã£o Base"
echo "==============================="

verifica_execucao_anterior
obter_hostname
instalar_nginx
registrar_execucao

echo ""
echo "ğŸ‰ InstalaÃ§Ã£o base concluÃ­da!"
